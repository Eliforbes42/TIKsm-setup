# Dynamic Dashboards

## Template Creation & Preparation

Start by creating and exporting your basic dashboard from Grafana. 

Be sure to create a variable to reference for host-name comparisons, as it will come in handy later.

### Datasource Prep

#### Template Prep

When importing dashboards via the configmap process (explained later), the datasource name is not automatically generated by Grafana. Therefore, you will have to manually replace any reference to the datasource variable.

   1. You'll need to find any occurrences of `${DS_INFLUXDB}` or `${DS_INFLUX}`.
   
   2. Generally they will be found in the `panels` list, on lines like `"datasource": "${DS_INFLUX}"`.

   3. Change each occurrence of `${DS_INFLUX}` to `influx`.

If you have a differing datasource, follow the below.
   
   1. Find the `__inputs` section, at the top of the exported dashboard file.

   2. The `name` of the input should follow the pattern of `DS_INPUT`.

   3. Below that will be a `label`.

   4. Use the value of that `label` and replace any occurrence of `${DS_INPUT}`

If you take a look at `systemDashboardTemplate.txt`, you should notice that there are numerous references to `WATCHEDNODE` in host-name comparisons. 

> Ex. `SELECT x FROM y WHERE (\"host\" =~ /WATCHEDNODE/) . . .`

If you made a variable for your host names, replace all occurrences of the variable to `WATCHEDNODE`. Otherwise, replace all host-name references with `WATCHEDNODE`.

> You may also utilize a different identifier, but we recommend what is used in `generateDashboards.sh` for consistency.

#### Chart Prep

If your Datasource is one other than other than InfluxDB or Flux, the preset datasources, follow the steps below, or take a look at [Grafana's Documentation](http://docs.grafana.org/administration/provisioning/#datasources).

> A list of all supported Grafana Datasource plugins are available, along with their setup configurations, [on Grafana's Datasource page](http://docs.grafana.org/features/datasources/).

The [`datasources`](https://github.com/Eliforbes42/cronus-monitoring/blob/master/charts/grafana/values.yaml#L146) section of the `grafana/values.yaml` file will be your starting point, and serves as an example for what's necessary in InfluxDB sources.

*Some explanation of the default configuration is given below, your configuration may vary.*

    name: influx
    type: influxdb              
    database: telegraf
    url: "http://data-influxdb.kube-system:8086"
    access: proxy
    isDefault: true

- `name`: The given name of the datasource, this is how it will be referred to in queries.

- `type`: The type of Datasource, see [Grafana's comprehensive list](http://docs.grafana.org/features/datasources/).

- `database`: The InfluxDB database used by Grafana.

- `url`: The protocol, IP, and port of the given datasource's API.

- `access`: The method of access, browser or server. Proxy is equivalent to server.

- `isDefault`: Determines if this datasource is set as default for queries.

Again, we recommend that you read up on your particular datasource over on [Grafana's Datasource page](http://docs.grafana.org/features/datasources/).

### Generation Script Prep

To incorporate your new dashboard template into the Dynamic Generation process, you will have to add in your own function to create dashboard files from the template.

The general algorithm is as follows, but we recommend you follow along in [`generatedashboards.sh`](https://github.com/Eliforbes42/cronus-monitoring/blob/master/scripts/generateDashboards.sh)

    yourDashGenFn() {
    - Store Node Variable from argument $1
    - Create your unique dashboard name
    - Replace host names with Node variable, write to generatedDashboards/uniqueName-metrics.json
    - Create unique dashboard id
    - Replace UID in created file (Your original dashboard UID may vary)
    - Notify user of dashboard creation
    }

---

## Configmap Explanation

In the `grafana` chart, you will find the values file `grafana/values.yaml`

About 3/4ths of the way through, you'll find the following

> dashboardsConfigMaps: 
    default: "all-dashboards"

This refers to the `all-dashboard-configmap`, found in [`grafana/templates/all-dashboard-configmap.yaml`](https://github.com/Eliforbes42/cronus-monitoring/blob/master/charts/grafana/templates/all-dashboard-configmap.yaml)

The main bit of logic in this configmap is as follows: 

> `{{ (.Files.Glob "dashboards/*.json").AsConfig | indent 2 }}`

This imports the JSON dashboards contained within `grafana/dashboards` as their own configmaps.